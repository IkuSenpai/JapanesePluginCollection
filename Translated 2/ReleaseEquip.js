/*:
@plugindesc
装備解放 Ver1.0.0(2022/4/1)

@url https://raw.githubusercontent.com/pota-gon/RPGMakerMZ/main/plugins/Equip/ReleaseEquip.js
@target MZ
@author ポテトードラゴン

・アップデート情報
- MITライセンスに変更

Copyright (c) 2022 ポテトードラゴン
Released under the MIT License.
https://opensource.org/licenses/mit-license.php

@help
## 概要
装備封印よりも強力な装備解放機能を追加します。

## 使い方
アクター・職業・武器・防具・ステートのメモ欄に  
ID指定の場合 <装備解放: 2> や <装備解放: 盾> などを記載します。  
すると、装備封印で封印されている装備も装備出来るようになります。

例: 大剣を片手で持つ大男などを実現できるようになります。

@param ReleaseEquipMetaName
@text 装備解放タグ
@desc 装備解放に使うメモ欄タグの名称
デフォルトは 装備解放
@default 装備解放
*/
(() => {
    'use strict';

    // ベースプラグインの処理
    function Potadra_getPluginName(extension = 'js') {
        const reg = new RegExp(".+\/(.+)\." + extension);
        return decodeURIComponent(document.currentScript.src).replace(reg, '$1');
    }
    function Potadra_meta(meta, tag) {
        if (meta) {
            const data = meta[tag];
            if (data) {
                return data.trim();
            }
        }
        return false;
    }

    // パラメータ用変数
    const plugin_name = Potadra_getPluginName();
    const params      = PluginManager.parameters(plugin_name);

    // 各パラメータ用定数
    const ReleaseEquipMetaName = String(params.ReleaseEquipMetaName) || '装備解放';

    // 装備解放の有無判定
    function isReleaseEquip(etypeId, meta) {
        const etype = Potadra_meta(meta, ReleaseEquipMetaName);
        if (isNaN(etype)) { // 文字列
            return etype === $dataSystem.equipTypes[etypeId];
        } else { // 数値
            return Number(etype) === etypeId;
        }
    }

    /**
     * 装備封印の判定
     *
     * @param {} etypeId - 
     * @returns {} 
     */
    Game_Actor.prototype.isEquipTypeSealed = function(etypeId) {
        // 装備解放の判定(アクター)
        if (isReleaseEquip(etypeId, this.actor().meta)) return false;

        // 装備解放の判定(職業)
        if (isReleaseEquip(etypeId, this.currentClass().meta)) return false;

        // 装備解放の判定(武器・防具)
        for (const item of this.equips()) {
            if (item && isReleaseEquip(etypeId, item.meta)) return false;
        }

        // 装備解放の判定(ステート)
        for (const stateId in this._stateSteps) {
            const state = $dataStates[stateId];
            if (state && isReleaseEquip(etypeId, state.meta)) return false;
        }

        // 装備封印の判定
        return this.traitsSet(Game_BattlerBase.TRAIT_EQUIP_SEAL).includes(etypeId);
    };
})();
